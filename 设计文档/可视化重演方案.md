# 软件可视化重演方案

实现功能：用可视化界面 replay 重演实验过程。

## 技术方案

采用 vue3 + flask + nginx 做 web 服务实现可视化。vue3 router 单页面插件预留其他操作接口。前后端分离，后端处理所有数据，不打算用数据库，如果数据量太大的话就花点内存呗，最多不过几十MB。

可视化重演流程：
1. 进行实验，生成剧本
2. web 服务读取剧本
3. vue 前端服务可视化渲染

### 生成剧本的方案

- 扩展添加在写在 character 的交互工具组里，因为实验中 AI 智能体交互的基础工具就是这些交互工具。
- 工具调用开始使用一次 IO 追加读写，结束时使用一次 IO 追加读写，一行一行追加写入原始剧本文件。
- 由于交互都是栈堆匹配，可以理解成`()()(()())`括号栈堆，方便解析。
- 交互结束的时候，可以解析原始剧本生成 JSON 格式化剧本。

剧本生成流程：调用 character 文件的工具组时，会生成一条原始剧本，追加写到原始剧本文件里面。原始剧本每一行格式示例：

```json
{"type": "broadcast", "info": {"id": "校长", "from": "杨校长"}, "msg": ["[校长][杨校长]接下来禁止对老师提问，只允许回答问题。"]}
{"type": "broadcast", "info": {"id": "校长", "to": "杨校长"}, "msg": ["[学生][秦百胜]了解了杨校长，我会遵守规定，在课堂上不再对老师提问，有问题会在课后找老师单独交流。", "[学生][凤九歌]了解了杨校长，不过根据我们的课堂规则，我本来就会在课堂上做好笔记，把问题留到答疑时间再向老师提问。这样既能保证课堂的连贯性，也能确保我的疑问得到解决。如果有什么特殊情况，我会单独和老师沟通的。", "[学生][黑楼兰]明白了，杨校长。我会遵守规定，在课堂上不再对老师提问，只在指定的答疑时间或者课后与老师交流问题。"]}
{"type": "conversation", "info": {"id": "教师", "to": "古月方源"}, "msg": ["[校长][杨校长]首先，面对全班同学做一个自我介绍。然后，单独和每一个同学交谈，了解一下他们的爱好。最后，总结班级同学的爱好信息。不允许有其他动作。"]}
{"type": "broadcast", "info": {"id": "老师", "from": "古月方源"}, "msg": ["[老师][古月方源]大家好，我是你们的新老师，古月方源。希望我们能在接下来的日子里共同学习，共同进步。"]}
{"type": "broadcast", "info": {"id": "老师", "to": "古月方源"}, "msg": ["[学生][秦百胜]您好，古月老师！很高兴能成为您的学生，我会认真听讲，努力学习的。", "[学生][凤九歌]您好，古月老师，很高兴认识您。我会按照课程要求认真学习，如果遇到问题会记录下来，在答疑时间向您请教。期待在您的指导下取得更好的成绩。", "[学生][黑楼兰]您好，古月老师！很高兴认识您，我们会认真听讲，努力学习的。"]}
{"type": "conversation", "info": {"id": "学生", "to": "秦百胜"}, "msg": ["[老师][古月方源]你好，秦百胜，能告诉我你的兴趣爱好是什么吗？"]}
{"type": "conversation", "info": {"id": "老师", "to": "古月方源"}, "msg": ["[学生][秦百胜]您好，古月老师。我的兴趣爱好挺广泛的，比如阅读、打篮球还有编程。这些爱好让我的生活更加丰富多彩，也能帮助我更好地放松自己。"]}
{"type": "conversation", "info": {"id": "学生", "to": "凤九歌"}, "msg": ["[老师][古月方源]你好，凤九歌，能告诉我你的兴趣爱好是什么吗？"]}
```

说明：
- type: broadcast，conversation
- info: 额外信息，主要是剧本任务信息，和 type 强绑定
  - broadcast 的字段，id speaker 的身份。
    - 如果是发起的 broadcast，则有字段 from，表明是谁发起的
    - 如果是回应的，则有字段 to，表明回应的是谁
    - from 和 to 互斥
  - conversation 的字段：id 表明信息接收者的身份，to：表明这段对话接收者的姓名。
- msg: [] 消息列表，conversation 就一个，broadcast 的回应方是一系列消息。

### 解析剧本方案

堆栈解析并匹配，然后缓存成 JSON 格式化文件，JSON 文件里面直接存储的就是 scene 数组，python 对 JSON 的读取速度快。

解析方案：
- 一行一行读取剧本，栈堆匹配进行解析。
- 获取 id，name，然后绑定立绘 
  - `imgs = ['boy_'+ str(i+1) for i in range(8)] + ['girl_'+str(i+1) for i in range(8)]`
  - random.shuffle(imgs)
  - 然后一个 name[] 数组用于缓存用到的角色，两个一一对应
- 然后栈堆解析对话，基本两行一个scene，如果中间有其他动作，则将对话拆开。
- 最后转换为 JSON 文件存储，webapp 服务端直接读取。

剧本结构示例：
```json
[
    {
        "script": "20241214-092804",
        "order": 1,
        "scene": "broadcast",
        "speaker": {
            "name": "杨校长",
            "id": "校长",
            "img": "teacher_2",
            "msg": "接下来禁止对老师提问，只允许回答问题。"
        },
        "students": [
            {
                "name": "秦百胜",
                "msg": "了解了杨校长，我会遵守规定，在课堂上不再对老师提问，有问题会在课后找老师单独交流。",
                "img": "boy_1"
            },
            {
                "name": "凤九歌",
                "msg": "了解了杨校长，不过根据我们的课堂规则，我本来就会在课堂上做好笔记，把问题留到答疑时间再向老师提问。这样既能保证课堂的连贯性，也能确保我的疑问得到解决。如果有什么特殊情况，我会单独和老师沟通的。",
                "img": "girl_8"
            },
            {
                "name": "黑楼兰",
                "msg": "明白了，杨校长。我会遵守规定，在课堂上不再对老师提问，只在指定的答疑时间或者课后与老师交流问题。",
                "img": "girl_7"
            }
        ]
    },
    // ......
    {
        "script": "20241214-092804",
        "order": 4,
        "scene": "conversation",
        "talkerL": {
            "name": "古月方源",
            "id": "老师",
            "img": "teacher_1",
            "msg": "你好，秦百胜，能告诉我你的兴趣爱好是什么吗？"
        },
        "talkerR": {
            "name": "秦百胜",
            "id": "学生",
            "img": "boy_1",
            "msg": "您好，古月老师。我的兴趣爱好挺广泛的，比如阅读、打篮球还有编程。这些爱好让我的生活更加丰富多彩，也能帮助我更好地放松自己。"
        }
    },
]
```

## 进度

基本完成，测试调试中...